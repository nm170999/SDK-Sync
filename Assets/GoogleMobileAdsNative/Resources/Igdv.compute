#pragma kernel sac
#pragma kernel csb
#pragma kernel bds
uint zb(uint u,uint f,uint t){u=min(t-1,max(0,u));f=min(t-1,max(0,f));return u*t+f;}bool apx(float u,float t){return abs(u-t)<1e-6;}uint4 cac(Texture2D<float4> t,uint2 u,uint R){const float O=.04,m=1e-5;float f[25],C[25],i[25],r[25],I[25],s[25],e=0,S=0.,h=0.;for(uint G=0;G<R;++G)for(uint D=0;D<R;++D){uint2 x={u.x+G-R/2,u.y+D-R/2};float4 F=t[x];f[G*R+D]=.299*F.x+.587*F.y+.114*F.z;}float FD=1.,T=0.;for(G=0;G<R;++G)for(uint x=0;x<R;++x){C[G*R+x]=f[zb(G,x-1,R)]+f[zb(G-1,x,R)]+f[zb(G+1,x,R)]+f[zb(G,x+1,R)]-4*f[zb(G,x,R)];FD=min(FD,C[G*R+x]);T=max(T,C[G*R+x]);}float xg=T-FD;xg=max(xg,1e-6);float F=255/xg;for(G=0;G<25;++G)C[G]=(C[G]-FD)*F;for(G=0;G<R;++G)for(uint y=0;y<R;++y){float n=C[zb(G-1,y-1,R)]-C[zb(G+1,y-1,R)]+2*C[zb(G-1,y,R)]-2*C[zb(G+1,y,R)]+C[zb(G-1,y+1,R)]+2*C[zb(G,y-1,R)],z=C[zb(G-1,y-1,R)]+2*C[zb(G,y-1,R)]+C[zb(G+1,y-1,R)]-C[zb(G-1,y+1,R)]-2*C[zb(G,y+1,R)]-C[zb(G+1,y+1,R)];uint k=zb(G,y,R);i[k]=n*n;r[k]=z*z;I[k]=n*z;}for(G=0;G<R;++G)for(uint gy=0;gy<R;++gy){float n=0,z=0,Y=0;for(uint k=0;k<3;++k)for(uint ac=0;ac<3;++ac){uint A=zb(G+k-1,gy+ac-1,R);n+=i[A];z+=r[A];Y+=I[A];}float acg=m*n*z-m*Y*Y-m*O*(n+z)*(n+z);s[zb(G,gy,R)]=acg;}for(G=0;G<R;++G)for(uint ky=0;ky<R;++ky){float k=0;for(uint a=0;a<5;++a)for(uint z=0;z<5;++z)k=max(k,s[zb(G+a-2,ky+z-2,R)]);if(k>1e3*m&&apx(k,s[zb(G,ky,R)])&&k>e){e=max(k,1.);S=u.x+G-R/2;h=u.y+ky-R/2;}}uint4 k={S,h,e,0};return k;}float4 rbc(Texture2D<float4> C,uint2 R){float4 G={0.,0.,0.,0.};uint n=9;for(uint u=0;u<n;u++)for(uint f=0;f<n;f++){uint x=R.x+u-n/2,y=R.y+f-n/2;uint2 A={x,y};float4 k=C[A];G+=k;}G/=n*n;G*=255.;return G;}Texture2D<float4> oiv;uint osa,rw,rh,rtl,tly,bmn,oof;RWStructuredBuffer<uint> oco;Texture2D<float4> igi;uint igs,nf,sw,sh;RWStructuredBuffer<uint> gfl,qaz,pjk;Texture2D<float4> cig;uint ctf;RWStructuredBuffer<uint> bzd,mn;uint cfh(uint2 G){uint u=(float)(G.x-rtl)/rw*bmn,R=(float)(G.y-tly)/rh*bmn;return oof+(u*bmn+R)%(bmn*bmn);}[numthreads(8,8,1)]void sac(uint3 G:SV_DispatchThreadID){uint u=rtl+G.x*osa,R=tly+G.y*osa;uint2 x={u,R};if(u<rtl||u>=rtl+rw||R<tly||R>=tly+rh)return;uint4 C=cac(oiv,x,osa);if(C.z>0){uint f=trunc(log2(C.z));f<<=13;f|=C.x;f<<=13;f|=C.y;InterlockedMax(oco[cfh(x)],f);}}[numthreads(64,1,1)]void csb(uint3 G:SV_DispatchThreadID){if(G.x>=ctf)return;uint u=bzd[2*G.x],R=bzd[2*G.x+1];uint2 x={u,R};float4 f=rbc(cig,x);uint C=(uint)f.x;C<<=8;C|=(uint)f.y;C<<=8;C|=(uint)f.z;mn[G.x]=C;}[numthreads(64,1,1)]void bds(uint3 G:SV_DispatchThreadID){uint u=gfl[G.x],R=(1<<13)-1,x=u&R;u>>=13;uint f=u&R;u>>=13;uint C=u&1;uint2 y={f,x};uint t=igs/2;if(G.x>=nf||f<t||f>=sw-t||x<t||x>=sh-t){pjk[G.x]=0;return;}uint4 F=cac(igi,y,igs);float4 k=rbc(igi,y);uint n=(1<<8)-1,m=qaz[G.x],z=m&n;m>>=8;uint a=m&n;m>>=8;uint O=m,e=k.x,s=k.y,h=k.z,D=(O+e)/2,S=O-e,Y=a-s,T=z-h,I=(2+D/256)*S*S,A=4*Y*Y,i=(2+(255-D)/256)*T*T,r=I+A+i;pjk[G.x]=((F.z>0?1:0)|((r<75000)<<1)|(h<<2)|(s<<10)|(e<<18));}
